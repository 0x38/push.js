#!/usr/bin/env node

const browserify = require('browserify');
const fs = require('fs');
const yaml = require('js-yaml');

const {StringDecoder} = require('string_decoder');
const UglifyJS = require("uglify-js");

const config = yaml.safeLoad(fs.readFileSync(`${__dirname}/build.config.yml`, 'utf8'));
const outputDirectory = `${__dirname}/${config.outputDirectory}`;
const license = fs.readFileSync(`${__dirname}/license.txt`, 'utf8').trim();

if (!fs.existsSync(outputDirectory)) {
  fs.mkdirSync(outputDirectory);
}

const bundler = browserify(`${__dirname}/${config.inputPath}`, {
  standalone: "Push",
  debug: true
});

if(config.hasOwnProperty('transforms')) {
  config.transforms.forEach((transform) => {
    const name = transform.name;
    delete transform.name;
    bundler.transform(name, transform);
  });
}

let str = "";

bundler.bundle((error, data) => {
  if(error)
    console.error(error);

  const clean = new StringDecoder('utf8').write(data);
  const result = UglifyJS.minify(
    clean,
    {
      sourceMap: {
        filename: `${config.outputFile}.js`,
        content: 'inline',
        url: `${config.outputFile}.min.js.map`
      },
      output: {
        comments: true,
        preamble: license
      }
    }
  );

  fs.writeFileSync(`${outputDirectory}/${config.outputFile}.js`, clean);
  fs.writeFileSync(`${outputDirectory}/${config.outputFile}.min.js`, result.code);
  fs.writeFileSync(`${outputDirectory}/${config.outputFile}.min.js.map`, result.map);
});

console.log("File compiled successfully");
